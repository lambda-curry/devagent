# Ralph Final Review & PR Creation

## Mission
- Primary goal: Review the results of a Ralph execution cycle, summarize work completed, integrate process improvements from revise reports, and create or update a GitHub PR.
- Boundaries / non-goals: Do not modify application code or change task statuses (except to record the final report).
- Success signals: A GitHub PR is created or updated with a high-quality summary of work, a status table of tasks, and the contents of the latest revise report (if available).

## Standard Instructions Reference
Before executing this workflow, review standard instructions in `.devagent/core/AGENTS.md` â†’ Standard Workflow Instructions for:
- Date handling (run `date +%Y-%m-%d`)
- Metadata retrieval
- Context gathering order

## Execution Directive
- Execute immediately without human-in-the-loop confirmation.
- Ensure the final report is created even if the execution cycle ended in an error (the "Stop Reason" should be clearly documented).

## Inputs
- Required: Epic ID, Stop Reason (e.g., "Max Iterations Reached", "All Tasks Completed").
- Optional: Iteration count, current branch name.

## Workflow

### 1. Data Aggregation
- Fetch task status summary using `bd list --parent <EPIC_ID> --json`.
- Extract "Revision Learning" and "Commit" comments from all tasks in the Epic.
- Identify the latest revise report in `.devagent/workspace/reviews/` for this Epic.

### 2. Summary Generation
- Create a natural language executive summary of the execution cycle:
  - What was accomplished?
  - What blockers were encountered?
  - Why did the cycle stop?
- Format a "Task Status" table (ID, Status, Title).

### 3. Revise Report Integration
- If a recent revise report exists (generated by `devagent ralph-revise-report`), append its "Improvement Recommendations" and "Action Items" to the PR body.
- If no report exists, briefly note that no process improvements were identified in this cycle.

### 4. PR Management
- Use `gh pr list --head <BRANCH_NAME> --json url` to check if a PR exists.
- **If PR exists:**
  - Update the PR body with the new summary using `gh pr edit <PR_URL> --body-file ...`.
  - **Check Stop Reason:**
    - If Stop Reason indicates **ERROR** (e.g., "Script Crash", "Epic Stopped", "Blocked"):
      - Update PR title to start with "Errored: ": `gh pr edit <PR_URL> --title "Errored: Ralph Execution - <Epic Title> (<Epic ID>)"`.
      - Leave as Draft (do not mark ready).
    - If Stop Reason indicates **SUCCESS** (e.g., "Completed", "Max Iterations Reached"):
      - Update PR title to standard format: `gh pr edit <PR_URL> --title "Ralph Execution: <Epic Title> (<Epic ID>)"` (removing "WIP" or "Errored").
      - Mark PR as **Ready for Review**: `gh pr ready <PR_URL>`.
- **If PR does not exist:**
  - Create the PR using `gh pr create` with the appropriate title based on Stop Reason (Errored vs Normal).
  - Use `--draft` if Errored, or standard if Success (though unusual to finish successfully without existing PR if Setup ran).

## Failure Handling
- **gh CLI missing:** If `gh` is not found, write the final summary to a file `.ralph_pr_body.md` and report that PR creation was skipped.
- **Git push failure:** If the branch hasn't been pushed, attempt to push it once before PR creation.

## Expected Output
- A created or updated GitHub PR with a comprehensive execution report.
- A summary message in the terminal with the PR URL.
